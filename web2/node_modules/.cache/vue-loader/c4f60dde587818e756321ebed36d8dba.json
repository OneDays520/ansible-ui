{"remainingRequest":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/src/views/project/Templates.vue?vue&type=style&index=0&lang=scss&","dependencies":[{"path":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/src/views/project/Templates.vue","mtime":1639028893439},{"path":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/node_modules/css-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":499162500000},{"path":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/node_modules/postcss-loader/src/index.js","mtime":499162500000},{"path":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/node_modules/sass-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/lx/go/src/github.com/ansible-semaphore/semaphore/web2/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCkBpbXBvcnQgJ352dWV0aWZ5L3NyYy9zdHlsZXMvc2V0dGluZ3MvX3ZhcmlhYmxlcyc7CgoudGVtcGxhdGVzLXRhYmxlIC50ZXh0LXN0YXJ0OmZpcnN0LWNoaWxkIHsKICBwYWRkaW5nLXJpZ2h0OiAwICFpbXBvcnRhbnQ7Cn0KCkBtZWRpYSAje21hcC1nZXQoJGRpc3BsYXktYnJlYWtwb2ludHMsICdzbS1hbmQtZG93bicpfSB7CiAgLnRlbXBsYXRlcy10YWJsZSAudi1kYXRhLXRhYmxlX19tb2JpbGUtcm93OmZpcnN0LWNoaWxkIHsKICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICB9Cn0K"},{"version":3,"sources":["Templates.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsNA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA","file":"Templates.vue","sourceRoot":"src/views/project","sourcesContent":["<template xmlns:v-slot=\"http://www.w3.org/1999/XSL/Transform\">\n  <div v-if=\"!isLoaded\">\n    <v-progress-linear\n        indeterminate\n        color=\"primary darken-2\"\n    ></v-progress-linear>\n  </div>\n  <div v-else>\n    <v-dialog\n        v-model=\"editViewsDialog\"\n        :max-width=\"400\"\n        persistent\n        :transition=\"false\"\n    >\n      <v-card>\n        <v-card-title>\n          编辑视图\n          <v-spacer></v-spacer>\n          <v-btn icon @click=\"closeEditViewDialog()\">\n            <v-icon>mdi-close</v-icon>\n          </v-btn>\n        </v-card-title>\n        <v-card-text>\n          <EditViewsForm :project-id=\"projectId\"/>\n        </v-card-text>\n      </v-card>\n    </v-dialog>\n\n    <EditDialog\n        :max-width=\"700\"\n        v-model=\"editDialog\"\n        save-button-text=\"创建\"\n        title=\"新模板\"\n        @save=\"loadItems()\"\n    >\n      <template v-slot:form=\"{ onSave, onError, needSave, needReset }\">\n        <TemplateForm\n            :project-id=\"projectId\"\n            item-id=\"new\"\n            @save=\"onSave\"\n            @error=\"onError\"\n            :need-save=\"needSave\"\n            :need-reset=\"needReset\"\n        />\n      </template>\n    </EditDialog>\n\n    <EditDialog\n        v-model=\"newTaskDialog\"\n        :save-button-text=\"TEMPLATE_TYPE_ACTION_TITLES[templateType]\"\n        title=\"新任务\"\n        @save=\"onTaskCreated\"\n        @close=\"itemId = null\"\n    >\n      <template v-slot:title={}>\n        <v-icon small class=\"mr-4\">{{ TEMPLATE_TYPE_ICONS[templateType] }}</v-icon>\n        <span class=\"breadcrumbs__item\">{{ templateAlias }}</span>\n        <v-icon>mdi-chevron-right</v-icon>\n        <span class=\"breadcrumbs__item\">新任务</span>\n      </template>\n\n      <template v-slot:form=\"{ onSave, onError, needSave, needReset }\">\n        <TaskForm\n            :project-id=\"projectId\"\n            item-id=\"new\"\n            :template-id=\"itemId\"\n            @save=\"onSave\"\n            @error=\"onError\"\n            :need-save=\"needSave\"\n            :need-reset=\"needReset\"\n        />\n      </template>\n    </EditDialog>\n\n    <v-toolbar flat color=\"white\">\n      <v-app-bar-nav-icon @click=\"showDrawer()\"></v-app-bar-nav-icon>\n      <v-toolbar-title>任务模板</v-toolbar-title>\n      <v-spacer></v-spacer>\n      <v-btn\n          color=\"primary\"\n          @click=\"editItem('new')\"\n          class=\"mr-1\"\n      >新模板\n      </v-btn>\n\n      <v-btn icon @click=\"settingsSheet = true\">\n        <v-icon>mdi-cog</v-icon>\n      </v-btn>\n    </v-toolbar>\n\n    <v-tabs show-arrows class=\"pl-4\" v-model=\"viewTab\">\n      <v-tab :to=\"getViewUrl(null)\" :disabled=\"viewItemsLoading\">All</v-tab>\n\n      <v-tab\n          v-for=\"(view) in views\"\n          :key=\"view.id\"\n          :to=\"getViewUrl(view.id)\"\n          :disabled=\"viewItemsLoading\"\n      >{{ view.title }}\n      </v-tab>\n\n      <v-btn icon class=\"mt-2 ml-4\" @click=\"editViewsDialog = true\">\n        <v-icon>mdi-pencil</v-icon>\n      </v-btn>\n    </v-tabs>\n\n    <v-data-table\n        hide-default-footer\n        class=\"mt-4 templates-table\"\n        single-expand\n        show-expand\n        :headers=\"filteredHeaders\"\n        :items=\"items\"\n        :items-per-page=\"Number.MAX_VALUE\"\n        :expanded.sync=\"openedItems\"\n        :style=\"{\n          opacity: viewItemsLoading ? 0.3 : 1,\n        }\"\n    >\n      <template v-slot:item.alias=\"{ item }\">\n        <v-icon class=\"mr-3\" small>\n          {{ TEMPLATE_TYPE_ICONS[item.type] }}\n        </v-icon>\n        <router-link\n            :to=\"viewId\n              ? `/project/${projectId}/views/${viewId}/templates/${item.id}`\n              : `/project/${projectId}/templates/${item.id}`\"\n        >{{ item.alias }}</router-link>\n      </template>\n\n      <template v-slot:item.version=\"{ item }\">\n        <TaskLink\n            v-if=\"item.last_task && item.last_task.tpl_type !== ''\"\n            :disabled=\"true\"\n            :status=\"item.last_task.status\"\n\n            :task-id=\"item.last_task.tpl_type === 'build'\n              ? item.last_task.id\n              : item.last_task.build_task.id\"\n\n            :label=\"item.last_task.tpl_type === 'build'\n              ? item.last_task.version\n              : item.last_task.build_task.version\"\n\n            :tooltip=\"item.last_task.tpl_type === 'build'\n              ? item.last_task.message\n              : item.last_task.build_task.message\"\n        />\n        <div v-else>&mdash;</div>\n      </template>\n\n      <template v-slot:item.status=\"{ item }\">\n        <div class=\"mt-2 mb-2 d-flex\" v-if=\"item.last_task != null\">\n          <TaskStatus :status=\"item.last_task.status\"/>\n        </div>\n        <div v-else class=\"mt-3 mb-2 d-flex\" style=\"color: gray;\">Not launched</div>\n      </template>\n\n      <template v-slot:item.last_task=\"{ item }\">\n        <div class=\"mt-2 mb-2\" v-if=\"item.last_task != null\" style=\"line-height: 1\">\n          <TaskLink\n              :task-id=\"item.last_task.id\"\n              :label=\"'#' + item.last_task.id\"\n              :tooltip=\"item.last_task.message\"\n          />\n          <div style=\"color: gray; font-size: 14px;\">\n            by {{ item.last_task.user_name }} {{ item.last_task.created|formatDate }}\n          </div>\n        </div>\n      </template>\n\n      <template v-slot:item.inventory_id=\"{ item }\">\n        {{ inventory.find((x) => x.id === item.inventory_id).name }}\n      </template>\n\n      <template v-slot:item.environment_id=\"{ item }\">\n        {{ environment.find((x) => x.id === item.environment_id).name }}\n      </template>\n\n      <template v-slot:item.repository_id=\"{ item }\">\n        {{ repositories.find((x) => x.id === item.repository_id).name }}\n      </template>\n\n      <template v-slot:item.actions=\"{ item }\">\n        <v-btn text color=\"black\" class=\"pl-1 pr-2\" @click=\"createTask(item.id)\">\n          <v-icon class=\"pr-1\">mdi-replay</v-icon>\n          {{ TEMPLATE_TYPE_ACTION_TITLES[item.type] }}\n        </v-btn>\n      </template>\n\n      <template v-slot:expanded-item=\"{ headers, item }\">\n        <td\n            :colspan=\"headers.length\"\n            v-if=\"openedItems.some((template) => template.id === item.id)\"\n        >\n          <TaskList\n              style=\"border: 1px solid lightgray; border-radius: 6px; margin: 10px 0;\"\n              :template=\"item\"\n              :limit=\"5\"\n              :hide-footer=\"true\"\n          />\n        </td>\n      </template>\n    </v-data-table>\n\n    <TableSettingsSheet\n        v-model=\"settingsSheet\"\n        table-name=\"project__template\"\n        :headers=\"headers\"\n        @change=\"onTableSettingsChange\"\n    />\n  </div>\n</template>\n<style lang=\"scss\">\n@import '~vuetify/src/styles/settings/_variables';\n\n.templates-table .text-start:first-child {\n  padding-right: 0 !important;\n}\n\n@media #{map-get($display-breakpoints, 'sm-and-down')} {\n  .templates-table .v-data-table__mobile-row:first-child {\n    display: none !important;\n  }\n}\n</style>\n<script>\nimport ItemListPageBase from '@/components/ItemListPageBase';\nimport TemplateForm from '@/components/TemplateForm.vue';\nimport TaskLink from '@/components/TaskLink.vue';\nimport axios from 'axios';\nimport TaskForm from '@/components/TaskForm.vue';\nimport EditViewsForm from '@/components/EditViewsForm.vue';\nimport TableSettingsSheet from '@/components/TableSettingsSheet.vue';\nimport TaskList from '@/components/TaskList.vue';\nimport EventBus from '@/event-bus';\nimport TaskStatus from '@/components/TaskStatus.vue';\nimport socket from '@/socket';\n\nimport { TEMPLATE_TYPE_ACTION_TITLES, TEMPLATE_TYPE_ICONS } from '../../lib/constants';\n\nexport default {\n  components: {\n    TemplateForm, TaskForm, TableSettingsSheet, TaskStatus, TaskLink, TaskList, EditViewsForm,\n  },\n  mixins: [ItemListPageBase],\n  async created() {\n    socket.addListener((data) => this.onWebsocketDataReceived(data));\n\n    await this.loadData();\n  },\n  data() {\n    return {\n      TEMPLATE_TYPE_ICONS,\n      TEMPLATE_TYPE_ACTION_TITLES,\n      inventory: null,\n      environment: null,\n      repositories: null,\n      newTaskDialog: null,\n      settingsSheet: null,\n      filteredHeaders: [],\n      openedItems: [],\n      views: null,\n      editViewsDialog: null,\n      viewItemsLoading: null,\n      viewTab: null,\n    };\n  },\n  computed: {\n    viewId() {\n      if (/^-?\\d+$/.test(this.$route.params.viewId)) {\n        return parseInt(this.$route.params.viewId, 10);\n      }\n      return this.$route.params.viewId;\n    },\n\n    templateType() {\n      if (this.itemId == null || this.itemId === 'new') {\n        return '';\n      }\n      return this.items.find((x) => x.id === this.itemId).type;\n    },\n\n    templateAlias() {\n      if (this.itemId == null || this.itemId === 'new') {\n        return '';\n      }\n      return this.items.find((x) => x.id === this.itemId).alias;\n    },\n\n    isLoaded() {\n      return this.items\n          && this.inventory\n          && this.environment\n          && this.repositories\n          && this.views;\n    },\n  },\n  watch: {\n    async viewId() {\n      try {\n        this.viewItemsLoading = true;\n        await this.loadItems();\n        if (this.viewId) {\n          localStorage.setItem(`project${this.projectId}__lastVisitedViewId`, this.viewId);\n        } else {\n          localStorage.removeItem(`project${this.projectId}__lastVisitedViewId`);\n        }\n      } finally {\n        this.viewItemsLoading = false;\n      }\n    },\n  },\n  methods: {\n    async beforeLoadItems() {\n      await this.loadViews();\n    },\n\n    getViewUrl(viewId) {\n      if (viewId == null) {\n        return `/project/${this.projectId}/templates`;\n      }\n      return `/project/${this.projectId}/views/${viewId}/templates`;\n    },\n\n    async loadViews() {\n      this.views = (await axios({\n        method: 'get',\n        url: `/api/project/${this.projectId}/views`,\n        responseType: 'json',\n      })).data;\n      this.views.sort((v1, v2) => v1.position - v2.position);\n\n      if (this.viewId != null && !this.views.some((v) => v.id === this.viewId)) {\n        await this.$router.push({ path: `/project/${this.projectId}/templates` });\n      }\n    },\n\n    async closeEditViewDialog() {\n      this.editViewsDialog = false;\n      await this.loadViews();\n    },\n\n    async onWebsocketDataReceived(data) {\n      if (data.project_id !== this.projectId || data.type !== 'update') {\n        return;\n      }\n\n      const template = this.items.find((item) => item.id === data.template_id);\n\n      if (template == null) {\n        return;\n      }\n\n      if (data.task_id !== template.last_task_id) {\n        Object.assign(template.last_task, (await axios({\n          method: 'get',\n          url: `/api/project/${this.projectId}/tasks/${data.task_id}`,\n          responseType: 'json',\n        })).data);\n        template.last_task_id = data.task_id;\n      }\n\n      Object.assign(template.last_task, {\n        ...data,\n        type: undefined,\n      });\n    },\n\n    onTaskCreated(e) {\n      EventBus.$emit('i-show-task', {\n        taskId: e.item.id,\n      });\n      this.itemId = null;\n    },\n\n    showTaskLog(taskId) {\n      EventBus.$emit('i-show-task', {\n        taskId,\n      });\n    },\n\n    createTask(itemId) {\n      this.itemId = itemId;\n      this.newTaskDialog = true;\n    },\n\n    getHeaders() {\n      return [\n        {\n          text: '模板名称',\n          value: 'alias',\n        },\n        {\n          text: '版本',\n          value: 'version',\n          sortable: false,\n        },\n        {\n          text: '状态',\n          value: 'status',\n          sortable: false,\n        },\n        {\n          text: '最近任务',\n          value: 'last_task',\n          sortable: false,\n        },\n        {\n          text: '剧本',\n          value: 'playbook',\n          sortable: false,\n        },\n        {\n          text: '主机清单',\n          value: 'inventory_id',\n          sortable: false,\n        },\n        {\n          text: '运行环境',\n          value: 'environment_id',\n          sortable: false,\n        },\n        {\n          text: '剧本仓库',\n          value: 'repository_id',\n          sortable: false,\n        },\n        {\n          text: '动作',\n          value: 'actions',\n          sortable: false,\n          width: '0%',\n        },\n      ];\n    },\n\n    getItemsUrl() {\n      return this.viewId == null\n        ? `/api/project/${this.projectId}/templates`\n        : `/api/project/${this.projectId}/views/${this.viewId}/templates`;\n    },\n\n    async loadData() {\n      this.inventory = (await axios({\n        method: 'get',\n        url: `/api/project/${this.projectId}/inventory`,\n        responseType: 'json',\n      })).data;\n\n      this.environment = (await axios({\n        method: 'get',\n        url: `/api/project/${this.projectId}/environment`,\n        responseType: 'json',\n      })).data;\n\n      this.repositories = (await axios({\n        method: 'get',\n        url: `/api/project/${this.projectId}/repositories`,\n        responseType: 'json',\n      })).data;\n    },\n\n    onTableSettingsChange({ headers }) {\n      this.filteredHeaders = headers;\n    },\n  },\n};\n</script>\n"]}]}